---

layout: post
title: 《深度学习推荐系统实战》笔记
category: 架构
tags: MachineLearning
keywords: recommender system

---

## 简介（持续更新）


商业社会中亘古不变的关系是供求关系，供求关系的背后是交换。无论是实体经济还是虚拟经济，都是基于这个原理。供求关系动态变化，当供给小于需求时，就产生了稀缺，有了稀缺，就有了商业。推荐系统处理的是信息，它的主要作用是在信息生产方和信息消费方搭建起桥梁。所以推荐系统是信息经济中的一个装置。那么在信息经济中供求到底又是什么呢？信息经济中，看上去供求方是信息生产者，需求方是注意力提供者。注意力有个特点：总量有限。在移动互联网普及之后，信息已经泛滥到很大程度，智能手机变成身体的一个器官，丰富的注意力被信息源以推荐的方式逐渐侵蚀，注意力从丰富变成稀缺。**信息源在打着灯笼到处寻找注意力**。

商业社会永远是逐利的，逐利的手段就是制造信息不对称，并且在制造过程中不断提高效率和降低成本。信息泛滥，信息过载，用户错过的信息量越来越多，注意力耗散很多，无法将耗散的注意力变现成了平台最大的痛。

## 整体架构

当你开始学习一个全新领域的时候，你想做的第一件事情是什么？我最想搞明白的是两个问题，一个是，这个领域到底要解决什么问题？第二个是，这个领域有没有一个非常高角度的思维导图，让我能够了解这个领域有哪些主要的技术，做到心中有数？

**推荐系统要处理的问题就可以被形式化地定义为**：对于某个用户U（User），在特定场景C（Context）下，针对海量的“物品”信息构建一个函数 ，预测用户对特定候选物品I（Item）的喜好程度，再根据喜好程度对所有候选物品进行排序，生成推荐列表的问题。

![](/public/upload/machine/recsys_overview.png)

居于中心位置的是一个抽象函数f(U,I,C)，它负责“猜测”用户的心，为用户可能感兴趣的物品打分，从而得出最终的推荐物品列表。在推荐系统中，这个函数一般被称为“推荐系统模型”。因为深度学习复杂的模型结构，让深度学习模型具备了理论上拟合任何函数的能力。如果说f(U,I,C) 这个推荐函数具有一个最优的表达形式，那传统的机器学习模型只能够拟合出f(U,I,C) 这个推荐函数的近似形式，而深度学习模型则可以最大程度地接近这个最优形式。近几年，由于深度学习模型的结构复杂度大大提高，使通过训练使模型收敛所需的数据量大大增加，这也反向推动了推荐系统大数据平台的发展，让推荐系统相关的大数据存储、处理、更新模块也一同迈入了“深度学习时代”。

在实际的推荐系统中，工程师需要着重解决的问题有两类。
1. 一类问题与数据和信息相关，即“用户信息”“物品信息”“场景信息”分别是什么？如何存储、更新和处理数据？
2. 另一类问题与推荐系统算法和模型相关，即推荐系统模型如何训练、预测，以及如何达成更好的推荐效果？

## 数据部分

大数据平台加工后的数据出口主要有 3 个：
1. 生成推荐系统模型所需的样本数据，用于算法模型的训练和评估。
2. 生成推荐系统模型服务（Model Serving）所需的“用户特征”，“物品特征”和一部分“场景特征”，用于推荐系统的线上推断。
3. 生成系统监控、商业智能（Business Intelligence，BI）系统所需的统计型数据。

### 特征工程

特征工程就是利用工程手段从“用户信息”“物品信息”“场景信息”中提取特征的过程。

从具体行为信息转化成抽象特征的过程，往往会造成信息的损失.
1. 具体的推荐行为和场景中包含大量原始的场景、图片和状态信息，保存所有信息的存储空间过大，我们根本无法实现。
2. 具体的推荐场景中包含大量冗余的、无用的信息，把它们都考虑进来甚至会损害模型的泛化能力。


尽可能地让特征工程抽取出的一组特征，能够保留推荐环境及用户行为过程中的所有“有用“信息，并且尽量摒弃冗余信息。
![](/public/upload/machine/feature_engineer.png)

推荐系统中的常用特征
1. 用户行为数据
    1. 显性反馈行为： 评分、 点赞等
    2. 隐性反馈行为：点击、加入购物车、购买、播放、 播放时长、评论、收藏等
2. 用户关系数据
    1. 显性：关注、好友等
    2. 隐性：点赞、同处一个社区、 同看一部电影等
3. 属性、标签类数据
4. 内容类数据：大段的描述型文字、图片，视频等。一般来说，内容类数据无法直接转换成推荐系统可以“消化”的特征，需要通过自然语言处理、计算机视觉等技术手段提取关键内容特征，再输入推荐系统。
5. 场景信息（上下文信息）：时间、地点、季节、 是否节假日、天气、空气质量、社会大事件等


所有的特征都可以分为两大类。
1. 第一类是类别、ID 型特征（以下简称类别型特征），拿电影推荐来说，电影的风格、ID、标签、导演演员等信息，用户看过的电影 ID、用户的性别、地理位置信息、当前的季节、时间（上午，下午，晚上）、天气等等，这些无法用数字表示的信息全都可以被看作是类别、ID 类特征。
2. 第二类是数值型特征，能用数字直接表示的特征就是数值型特征，典型的包括用户的年龄、收入、电影的播放时长、点击量、点击率等。

我们进行特征处理的目的，是把所有的特征全部转换成一个数值型的特征向量
1. 对于类别、ID 类特征，我们应该怎么处理它们呢？One-hot 编码（也被称为独热编码）它通过把所有其他维度置为 0，单独将当前类别或者 ID 对应的维度置为 1 的方式生成特征向量。
    1. 比如星期二 用`[0,1,0,0,0,0,0]` 表示
    2. ，ID 型特征也经常使用 One-hot 编码，假设我们的电影库中一共有 1000 部电影，电影 M 的 ID 是 310（编号从 0 开始），那这个行为就可以用一个 1000 维的向量来表示，让第 310 维的元素为 1，其他元素都为 0。
    3. 对于历史行为序列类、标签特征等数据来说，用户往往会与多个物品产生交互行为，或者一个物品被打上多个标签，这时最常用的特征向量生成方式就是把其转换成 Multi-hot 编码。
2. 对于数值型特征
    1. 对特征的尺度归一化，对于电影来说， 评价次数的范围一般在[0,无穷大]之间，评分的取值范围在[0,5]之间，如果我们把特征的原始数值直接输入推荐模型，就会导致这两个特征对于模型的影响程度有显著的区别。
    2. 用分桶的方式解决特征分布不均匀的问题，由于人们打分有“中庸偏上”的倾向，因此评分大量集中在 3.5 的附近，这对于模型学习来说也不是一个好的现象，因为特征的区分度并不高。所谓“分桶（Bucketing）”，就是将样本按照某特征的值从高到低排序，然后按照桶的数量找到分位数，将样本分到各自的桶中，再用桶 ID 作为特征值。改变特征分布 还有取开方、平方等，如果无法通过人工的经验判断哪种特征处理方式更好，可以把它们都输入模型，让模型来做选择。

特征处理这块，spark MLlib 和 机器学习库 都提供了处理函数。

### Embedding

Embedding 就是用一个数值向量“表示”一个对象（Object）的方法。“实体对象”可以是image、word等，“数值化表示”就是一个编码向量。例如对“颜色“这种实体对象用（R，G，B）这样一个三元素向量编码。embedding还可以理解成将离散目标投影到连续空间中的某个点上。数值化的embedding vector本身是没有意义的，不同vector之间的相对关系才是有实际意义的。例如：NLP中最基本的word embedding，给每一个单词一个N维编码向量（或者说将每个word投影到N维空间中），我们期望这种编码满足这样的特性：两个向量之间的”距离“越小，代表这两个单词含义越接近。比如利用 Word2vec 这个模型把单词映射到了高维空间中，从 king 到 queen 的向量和从 man 到 woman 的向量，无论从方向还是尺度来说它们都异常接近。

![](/public/upload/machine/embedding_demo.png)

Embedding 技术对深度学习推荐系统的重要性
1. Embedding 是处理稀疏特征的利器。因为推荐场景中的类别、ID 型特征非常多，大量使用 One-hot 编码会导致样本特征向量极度稀疏，而深度学习的结构特点又不利于稀疏特征向量的处理，因此几乎所有深度学习推荐模型都会由 Embedding 层负责将稀疏高维特征向量转换成稠密低维特征向量。
2. Embedding 可以融合大量有价值信息，本身就是极其重要的特征向量 。 相比由原始信息直接处理得来的特征向量，Embedding 的表达能力更强，特别是 Graph Embedding 技术被提出后，Embedding 几乎可以引入任何信息进行编码，使其本身就包含大量有价值的信息，所以通过预训练得到的 Embedding 向量本身就是极其重要的特征向量。

利用Tensorboard很容易将embedding进行可视化，不过既然是可视化，最高只能“可视”三维空间，所以高维向量需要被投影到三维（或二维空间）。不过不用担心细节，Tensorboard做了足够高质量的封装。


## 算法部分

模型的结构一般由“召回层”、“排序层”以及“补充策略与算法层”组成。
1. “召回层”一般由高效的召回规则、算法或简单的模型组成，这让推荐系统能快速从海量的候选集中召回用户可能感兴趣的物品。
2. “排序层”则是利用排序模型对初筛的候选集进行精排序。
3. “补充策略与算法层”，也被称为“再排序层”，是在返回给用户推荐列表之前，为兼顾结果的“多样性”“流行度”“新鲜度”等指标，结合一些补充的策略和算法对推荐列表进行一定的调整，最终形成用户可见的推荐列表。

深度学习对于推荐系统的革命集中在模型部分，那具体都有什么呢？
1. 深度学习中 Embedding 技术在召回层的应用。
2. 不同结构的深度学习模型在排序层的应用。
3. 增强学习在模型更新、工程模型一体化方向上的应用。让推荐系统可以在实时性层面更上一层楼。